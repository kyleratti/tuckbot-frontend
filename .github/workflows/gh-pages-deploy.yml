name: CI/CD
on:
  push:
    branches: [master]
    paths:
      - "src/**"
      - "package.json"
      - "package-lock.json"
      - "webpack.config.js"
env:
  NODE_ENV: PRODUCTION
  API_SERVER_ROOT: ${{ secrets.API_SERVER_ROOT }}
  GOOGLE_ANALYTICS_TRACKING_ID: ${{ secrets.GOOGLE_ANALYTICS_TRACKING_ID }}
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - name: Build 🔨
        run: |
          npm install
          npm run build
          ls ./
      - name: Save build 📨
        uses: actions/upload-artifact@v2
        with:
          name: build
          path: |
            dist/
            package.json
            package-lock.json
            webpack.config.js
      - name: Cache dependencies 💾
        uses: actions/cache@v2
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
  prerender:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Cache dependencies 💾
        uses: actions/cache@v2
        with:
          path: |
            **/node_modules
          key: ${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
      - name: Retrieve build 📨
        uses: actions/download-artifact@v2
        with:
          name: build
      - name: Prerender SPA 🔶➡️🔶
        run: |
          npm run predeploy
      - name: Save dist 📨
        uses: actions/upload-artifact@v2
        with:
          name: prerender
          path: |
            dist/
            src/
            webpack.config.js
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    needs: [prerender]
    steps:
      - name: Retrieve dist 📨
        uses: actions/download-artifact@v2
        with:
          name: prerender
      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages
          FOLDER: dist
          CLEAN: true
      - name: Clean up artifacts 🧹
        uses: gekkyeggo/delete-artifact@v1
        with:
          name: |
            build
            prerender
